#!/usr/bin/env perl
# repath and archive finished build on remote host

use 5.010;
use warnings;
use strict;

use JSON::PP;
use File::Find;
use File::Path;
use File::Copy;
use Term::ANSIColor;
use Config;
use FindBin;
use lib "$FindBin::Bin/../lib";
use open qw< :encoding(UTF-8) >;
use Cydia::Meta;

say "### cybd STARTING";
#my @base = "$ENV{HOME}/.cypm/pool";
my( $base )= qw< ./cy >;
my @packlist_orig = ();

say colored(['black on_yellow'],"new find: ");
sub wanted {
    if(/\.packlist/){
        say 'packlist ' . $_;
        push @packlist_orig, "$File::Find::dir/$_";
    } else {
        #say "no packlist " . $_;
    }
}
find(\&wanted, $base);

say "original packlist";
say @packlist_orig; 


# --define dir paths
my $installsitelib = $Config{installsitelib};
$installsitelib =~ s/^\///;
say "installsitelib: " . $installsitelib;

my $installbin = $Config{installbin};
$installbin =~ s/^\///;
say "installbin: " . $installbin;

my $cytar_lib = $installsitelib;
$cytar_lib =~ s/(.*?)(\/.*)/$1/;
say "cytar_lib: " . $cytar_lib;

my $cytar_bin = $installbin;
$cytar_bin =~ s/(.*?)(\/.*)/$1/;
say "cytar_bin: " . $cytar_bin;

# --

#system("mv $base/* $installsitelib/");


#find( sub { move("$File::Find::dir/$_", $installbin) }, qw< cy > );
#say "find: moving $File::Find::dir/$_ -> $installbin";


my $O_O = sub {
    my $line = shift;
    my $colo = 'white on_bright_black';
    my $name = 'log:';
    my $say = sub { say colored([$colo], $name ).'->'.colored([$colo], $line) };
    $say->();
};

# todo: add xz/lzma compression option (1)
my $move_pack = sub {
    my $repo = shift;
    my $cargo = <<"_CYDIA";
    cat .www >> ../.stash/cydia/.www
    mv *.deb ~/.cypm/.stash/cydia/deb
    cd $ENV{CYSTASH}/cydia
    cysp
    tar -zcvf cydia.tgz Packages.gz deb .www
    scp cydia.tgz $repo:~/www/cydia
_CYDIA
    my $transfer = sub {
        system("$cargo");
    }; $transfer->();
};

my $make_pack = sub { 
    my $pm = shift;
    my $ar = <<"_DEB";
    cd $pm; tar -xvf data.tar.gz;
    rm data.tar.gz;
    tar czf ../data.tar.gz $installsitelib $installbin;
    cd DEBIAN/;
    tar czf ../../control.tar.gz *;
    cd ../..;
    echo 2.0 > debian-binary;
    arfp r $pm.deb debian-binary control.tar.gz data.tar.gz;
_DEB
    #tar czf ../data.tar.gz [a-z]*;
    my $package = sub {
        my $packer = shift;
        my $status  = system($packer);
    }; 
    my $status = $package->($ar);
};

my $check_pack = sub {
    my $p = shift;

    for my $pack( @$p ){
            $O_O->( "STARTING check_pack" );

            # -- list content of received packlist
            say "- module: $pack->{path}";
            say "- pkg: $pack->{pkg}";

            print colored(['yellow'],"packlist content: ") . "\n"; ###log

            for(@{$pack->{packlist}}){ say $_ }
            # --
    
            my $make_path = system("mkdir -p $pack->{pkg}/DEBIAN");
            my $control = system("touch $pack->{pkg}/DEBIAN/control");
            my $fh = undef;

            say "- creating control file for $pack->{module}";

            my $fn = "$ENV{HOME}/.cypm/pool/$pack->{pkg}/DEBIAN/control";
            open( $fh, '>', $fn ) or die "can't open $fn: $!";
            print $fh control("$pack->{module}") . "\n";
            close $fh;

            say "- control content:"; 
            say control($pack->{module});

            my $packlist_fh = undef;
            open( $packlist_fh, "> $pack->{path}" ) or die "cant open it $!";

        #rewrite original packlist
            for(@{$pack->{ packlist }}){
                say $packlist_fh $_;
            }; close $packlist_fh;

        #create new data.pack using new packlist
            my $datapack = sub {
                my $tar = system("tar cz -T $pack->{path} -f $pack->{pkg}/data.tar.gz");
                my $mv = system("mv $pack->{path} $pack->{pkg}/");
            };
            print "\npulling datapack: ";  $datapack->();


        #call makepack, build deb
            print "\npackaging deb: "; $make_pack->( $pack->{ pkg } );
            #$O_O->( "make>pack>status->$status |$pack->{pkg} in stash|" ) unless $status;
            
        #move new packlist
        system("mv $pack->{path} $pack->{pkg}");

        #web
            print "\nhtml div:"; web($pack->{module});
            #$O_O->( "make>html>components->ok" ) unless $div;
    }

};

my $list_pack = sub {
    my $p = shift;
    my @pack = ();
    my( @meta )= ();

    $O_O->( "STARTING list_pack" );
    print colored(['yellow'],"received packlists: ") . "\n"; ###log
    print $_ . "\n" for (@$p);

    for my $path( @$p ){
        chomp(my $module = $path);

        # make module($pm) name from packlist($path)

        $module =~ s/(auto.*?\/)(.*?)(\/\.packlist)/$2/;
        $module = $2;
        $module =~ s/\//\:\:/g;
        print colored(['yellow'],"module is: ") . $module . "\n"; ###log

        #read content(file paths) of current packlist
        open( my $fh, "<", $path );

        print colored(['yellow'],"packlist content is: ") . "\n"; ###log
        while(<$fh>){
            chomp;
            say $_;
        }

        print colored(['yellow'],"while loop: ") . "\n"; ###log
        open( my $fh, "<", $path );
        while( <$fh>){
            chomp;
            say $_;
            #content(file paths) of current packlist
            # --
            my $home = qr/$ENV{HOME}/;
            if( /\/cy\// ){
                if(/$home/){

                    s/(.*?)(\/cy\/)(.*)/$2$3/;
                    push @pack, $_;

                    print colored(['magenta'],"adding: ") . "$_ didnt matched $home" . "\n"; ###log

                }
            } else {
                print colored(['red'],"skipping: ") . "$_ matched $home" . "\n"; ###log
            }
        }
        
        my $meta = meta($module);
        my $pkg = $meta->{pkg};

        my $pack = {
            pkg        =>  $pkg,
            module     =>  $module,
            path       =>  $path,
            packlist   =>  \@pack,
        };         
    push @meta, $pack;
    close $fh;
    }
    $check_pack->( \@meta );
};

$list_pack->(\@packlist_orig);
#my $repo = 'mobile@load.sh';
#$move_pack->($repo);

__DATA__
1. xz/lmza on telesphoero needs fix4 
tar -cf - usr | xz -9 -c - > ../data.tar.xz
tar -cf - usr | lzma -9 -c - > ../data.tar.lmzm
